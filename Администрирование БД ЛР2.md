#### Лабораторная работа №02: Организация данных и системный каталог

**Выполнил:** студент 4 курса группы ПИЖ-б-о-22-1 Плугатырев Владислав Алексеевич

**Тема:** Организация данных и системный каталог

**Цель работы:**  Всестороннее изучение логической и физической структуры хранения данных в PostgreSQL. Получение практических навыков управления базами данных, схемами, табличными пространствами. Глубокое освоение работы с системным каталогом для извлечения метаинформации. Исследование низкоуровневых аспектов хранения, включая TOAST.

--- 

## Порядок выполнения работы

### Модуль 1. Базы данных и схемы

#### 1. Создание и проверка БД.
![[Pasted image 20250925164106.png]]
Рисунок 1.1 - Создание БД и проверка ее размера

#### 2. Работа со схемами.
![[Pasted image 20250925164435.png]]
Рисунок 1.2 - Создание схем

![[Pasted image 20250925164825.png]]
Рисунок 1.3 - Создание таблиц в схемах

![[Pasted image 20250925165038.png]]
Рисунок 1.4 - Вставка данных в таблицу

#### 3. Контроль размера.
![[Pasted image 20250925165145.png]]
Рисунок 1.5 - Проверка размера БД

**Объяснение:** Размер БД увеличится, так как мы добавили новые объекты (схемы, таблицы, последовательности для `SERIAL`) и данные. Системные таблицы (`pg_class`, `pg_attribute`, где `pg_class` содержит информацию о таблицах и подобных им объектов, а `pg_attribute` содержит каталог столбцов) также пополнились записями о новых объектах.

#### 4. Управление путем поиска.
![[Pasted image 20250925165730.png]]
Рисунок 1.6 - Изменение параметра search_path

![[Pasted image 20250925165835.png]]
Рисунок 1.7 - Демонстрация работы

#### 5. Практика (настройка параметра БД)
![[Pasted image 20250925170030.png]]
Рисунок 1.8 - Текущее значение параметра temp_buffers

![[Pasted image 20250925170259.png]]
 Рисунок 1.9 - Подключение к БД postgres, изменение параметра temp_buffers для БД lab02_db, проверка изменений

### Модуль 2. Системный каталог

#### 1. Исследование `pg_class`
![[Pasted image 20250925170602.png]]
Рисунок 2.1 - Структура таблицы `pg_class`

**Вывод:** Покажет структуру таблицы `pg_class`: столбцы (`oid`, `relname`, `relnamespace`, `relkind` и т.д.) и их типы. Эта таблица хранит информацию обо всех отношениях (таблицах, индексах, последовательностях, представлениях).

#### 2.  Исследование `pg_tables`.
![[Pasted image 20250925170732.png]]
Рисунок 2.2 - Определения представления `pg_tables`

**Вывод:** Покажет определение представления `pg_tables` (столбцы и SQL-запрос, который его формирует).  
**Объяснение разницы:** `pg_class` - это системная **таблица**, хранящая сырые данные. `pg_tables` - это **представление** (view), которое является сохранённым SQL-запросом, выбирающим и форматирующим данные из одной или нескольких системных таблиц (включая `pg_class`) для удобного просмотра информации именно о таблицах.

#### 3. Временная таблица и список схем.

![[Pasted image 20250925171347.png]]
Рисунок 2.3 - Создание временной таблицы

![[Pasted image 20250925171410.png]]
Рисунок 2.4 - Список всех схем (пространств имен)

**Вывод:** Среди прочих видны схемы `pg_catalog`, `information_schema`, `public`, `app`, `lofanbl4`, а также схему с именем типа `pg_temp_4`.  
**Объяснение:** Временные таблицы создаются в специальной временной схеме, которая уникальна для каждого сеанса. Это нужно для изоляции временных данных разных сеансов.

#### 4. Представления `information_schema`.

![[Pasted image 20250925171725.png]]
Рисунок 2.5 - Список представлений в схеме `information_schema`

#### 5. Анализ метакоманды `\d+ pg_views`.

![[Pasted image 20250925171952.png]]
Рисунок 2.6 - Выполнение метакоманды

**Объяснение:** Команда `\d+` в `psql` является метакомандой. Она формирует и выполняет запросы к системному каталогу, чтобы представить информацию в удобочитаемом виде. За этой командой скрываются запросы к таким таблицам, как `pg_class` (для получения общего описания), `pg_attribute` (для получения информации о столбцах) и другим, в зависимости от объекта.

### Модуль 3. Табличные пространства

#### 1. Создание `Tablespace`.

**Табличное пространство (Tablespace)** в PostgreSQL — это абстракция, которая позволяет определять, **где на диске** будут храниться файлы данных базы данных. Это механизм для управления физическим размещением данных.

![[Pasted image 20250925172440.png]]
Рисунок 2.7 - Создание каталога

![[Pasted image 20250925172849.png]]
Рисунок 2.8 - Создание табличного пространства

#### 2. `Tablespace` по умолчание для `template1`.

![[Pasted image 20250925173408.png]]
Рисунок 2.9 - Создание табличного пространства и изменение табличного пространства по умолчанию для БД template1

**Цель действия:** База данных `template1` используется как шаблон по умолчанию при создании новых баз данных. Установив для неё tablespace по умолчанию, мы гарантируем, что все новые БД, созданные без явного указания tablespace, будут использовать `lab02_ts`.

#### 3. Наследование свойства.

![[Pasted image 20250925173941.png]]
Рисунок 3.1 - Создание новой БД

![[Pasted image 20250925174008.png]]
Рисунок 3.2 - Проверка табличного пространства для созданной БД

**Объяснение результата:** Новая БД `lab02_db_new` унаследует табличное пространство `lab02_ts`, потому что она была создана на основе `template1`, для которого установлено `lab02_ts` как пространство по умолчанию.

#### 4. Символическая ссылка.

**Символическая ссылка** (symbolic link или symlink) — это специальный файл в файловой системе, который **содержит путь к другому файлу или директории**. Это своего рода "ярлык" или "указатель" на оригинальный файл.

![[Pasted image 20250925174811.png]]
Рисунок 3.3 - Определение OID tablespace

![[Pasted image 20250925174931.png]]
Рисунок 3.4 - Определение OID через psql

![[Pasted image 20250925175058.png]]
Рисунок 3.5 - Проверка куда ведет символическая ссылка

**Вывод:** Символическая ссылка будет вести на каталог `/tmp/mytablespace`, который мы указали при создании tablespace.

#### 5. Удаление `Tablespace`

![[Pasted image 20250925175441.png]]
 Рисунок 3.6 - Удаление БД и табличного пространства
#### 6. Практика+ (Параметр Tablespace).

![[Pasted image 20250925175654.png]]
Рисунок 3.7 - Установка параметра `random_page_cost` и проверка


### Модуль 4. Низкий уровень

#### 1. Нежурналируемая таблица.

**Нежурналируемая таблица** (англ. unlogged table) — это специальный тип таблицы в PostgreSQL, данные которой не записываются в журнал предзаписи (Write-Ahead Log, WAL). Это даёт существенный прирост производительности при записи, но в случае сбоя (аварийного завершения, отключения питания и т.п.) все данные в таких таблицах будут утеряны.

![[Pasted image 20250925180414.png]]
Рисунок 3.8 - Создание временного табличного пространства, нежурналируемой таблицы и проверка файла с суффиксом `_init`.

Слой `_init` используется для быстрой инициализации нежурналируемых таблиц.

#### 2. Стратегии хранения TOAST.

**TOAST** (The Oversized-Attribute Storage Technique) — это встроенная в PostgreSQL технология для эффективного хранения больших значений полей, которые не помещаются в стандартную страницу данных (обычно 8 КБ).

![[Pasted image 20250925180818.png]]
Рисунок 3.9 - Создание таблицы с текстовым концом, определение стратегии хранения по умолчанию, изменение стратегии на EXTERNAL

![[Pasted image 20250925181123.png]]
Рисунок 4.1 - Вставка значений, проверка TOAST-таблицы, проверка данных в таблице

**Объяснение результата:** для короткой строки запись в TOAST-таблице будет пустой или отсутствовать, так как она помещается в основную таблицу (встроенное хранение). Для длинной строки в TOAST-таблице появится запись, так как её размер превышает порог (обычно 2 КБ) и требует out-of-line хранения.

#### 3. Практика+ (Анализ размера БД).

![[Pasted image 20250925181500.png]]
Рисунок 4.2 - Анализ размеров

**Объяснение расхождения:** Размер БД всегда больше суммы размеров таблиц. В размер БД входят:
- Размер системных таблиц (`pg_class`, `pg_attribute` и др.)
- Размер индексов
- Размер TOAST-таблиц
- Размер свободного пространства (зарезервированного под будущие данные)
- Журнал транзакций (WAL), хотя он обычно учитывается отдельно.

#### 4. Практика+ (Методы сжатия TOAST).

![[Pasted image 20250925181643.png]]
Рисунок 4.3 - Методы сжатия

#### 5. Практика+ (Сравнение сжатия)

![[Pasted image 20250925181912.png]]
Рисунок 4.4 - Создание большого файла

![[Pasted image 20250925181952.png]]
Рисунок 4.5 - Создание таблицы без сжатия и сжатием

![[Pasted image 20250925182649.png]]
Рисунок 4.6 - Загрузка данных и замерка времени
![[Pasted image 20250925182753.png]]
Рисунок 4.7 - Сравнение размеров

**Вывод:**  изучил логическую и физическую структуры хранения данных в PostgreSQL. Получил практические навыки управления базами данных, схемами, табличными пространствами. Освоил работу с системным каталогом для извлечения метаинформации. Исследовал низкоуровневых аспектов хранения, включая TOAST.